generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum TransactionType {
  BUY
  SELL
  TRANSFER_IN
  TRANSFER_OUT
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

enum PositionStatus {
  OPEN
  CLOSED
  PARTIAL
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  passwordHash    String
  fullName        String
  plan            UserPlan  @default(FREE)
  planExpiresAt   DateTime?
  refreshToken    String?
  isActive        Boolean   @default(true)
  emailVerified   Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  wallets         Wallet[]
  strategies      TradingStrategy[]
  apiKeys         ApiKey[]

  @@index([email])
  @@map("users")
}

model Wallet {
  id                    String    @id @default(cuid())
  userId                String
  sniperooWalletId      String?   @unique
  name                  String
  publicKey             String    @unique
  encryptedPrivateKey   String
  balance               Float     @default(0)
  isActive              Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions             Position[]
  transactions          Transaction[]

  @@index([userId])
  @@index([publicKey])
  @@map("wallets")
}

model TradingStrategy {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  isActive    Boolean   @default(false)
  config      Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("trading_strategies")
}

model Position {
  id              String          @id @default(cuid())
  walletId        String
  tokenAddress    String
  tokenSymbol     String?
  tokenName       String?
  entryPrice      Float
  currentPrice    Float
  quantity        Float
  status          PositionStatus  @default(OPEN)
  realizedPnl     Float           @default(0)
  unrealizedPnl   Float           @default(0)
  openedAt        DateTime        @default(now())
  closedAt        DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  wallet          Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@index([walletId])
  @@index([tokenAddress])
  @@index([status])
  @@map("positions")
}

model Transaction {
  id              String              @id @default(cuid())
  walletId        String
  positionId      String?
  type            TransactionType
  signature       String              @unique
  tokenAddress    String
  amount          Float
  price           Float
  totalValue      Float
  fee             Float               @default(0)
  status          TransactionStatus   @default(PENDING)
  blockTime       DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  wallet          Wallet              @relation(fields: [walletId], references: [id], onDelete: Cascade)
  position        Position?           @relation(fields: [positionId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([positionId])
  @@index([signature])
  @@index([status])
  @@map("transactions")
}

model ApiKey {
  id          String    @id @default(cuid())
  userId      String
  name        String
  keyHash     String    @unique
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}
